---

# tasks file for osp.servers
- name: Create new server instances and attaches them a network and passes metadata to the instance
# loop on the values in osp_servers to populate all of the os_server information
  block:
    - name: OS Server Build "{{ item.key }}"
      os_server:
        cloud:       "{{ item.0.value }}"
        name:        "{{ item.1.value }}"
        region_name: "{{ item.2.value }}"
        state:       "{{ item.3.value) }}"
        image: "{{ item.4.value }}"
        key_name: "{{ item.5.value }}"
        interface: "{{ item.6.value }}"
        flavor: "{{ item.7.value }}"
        security_groups:
          "{ - { item.8.value } }"
        network: "{{ item.9.value }}"
        meta: "{ group: { item.10.value }, deployment_name: { item.11.value } }"
        wait: true
        userdata: |
          #!/bin/bash
          curl -o /tmp/openstack.pub http://www.opentlc.com/download/ansible_bootcamp/openstack_keys/openstack.pub
          cat /tmp/openstack.pub >> /home/cloud-user/.ssh/authorized_keys
          curl -o /tmp/internal.repo http://www.opentlc.com/download/ansible_bootcamp/repo/internal.repo
          cp /tmp/internal.repo /etc/yum.repos.d/internal.repo
      register: instanceip
