---

# tasks file for osp.servers
- name: Create new server instances and attaches them a network and passes metadata to the instance
# loop on the values in osp_servers to populate all of the os_server information
  block:
    - name: OS Server Build "{{ name.value }}"
      os_server:
        state: "{{ state.value }}"
        name: "{{ name.value }}"
        cloud: "{{ cloud.value }}"
        region_name: "{{ region_name.value }}"
        interface: internal
        nics:
          - net-name: int_network
        key_name: "{{ key_name.value }}"
        image: "{{ image.value }}"
        flavor: "{{ flavor.value }}"
        meta: "{ group: { group.value }, deployment_name: { deployment_name.value } }"
        security_groups: "{{ security_group.value }}"
        wait: yes
        userdata: |
          #!/bin/bash
          curl -o /tmp/openstack.pub http://www.opentlc.com/download/ansible_bootcamp/openstack_keys/openstack.pub
          cat /tmp/openstack.pub >> /home/cloud-user/.ssh/authorized_keys
          curl -o /tmp/internal.repo http://www.opentlc.com/download/ansible_bootcamp/repo/internal.repo
          cp /tmp/internal.repo /etc/yum.repos.d/internal.repo
      register: instanceip
#curl -o /tmp/internal.repo http://www.opentlc.com/download/ansible_bootcamp/repo/internal.repo
    - name: Add floating IP to Servers
      os_floating_ip:
        cloud: "{{ item.value.cloud }}"
        state: present
        reuse: yes
        server: "{{ item.value.name }}"
        network: ext_network
        wait: true
        timeout: 180
      register: instancefloatingip
    - name: Show "{{ instanceip }}" public IP
      debug: var=instancefloatingip.floating_ip.floating_ip_address

    - name: Wait for "{{ item.value.name }}" to be available
      wait_for:
        host: "{{ instancefloatingip.floating_ip.floating_ip_address }}"
        port: 22
        search_regex: OpenSSH
        timeout: 600
        delegate_to: "{{ inventory_hostname }}"

    #- debug:
    #    msg: successfully deployed server and network for "{{ item.key }}"
